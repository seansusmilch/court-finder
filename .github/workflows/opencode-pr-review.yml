name: OpenCode PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  opencode:
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.draft == false) ||
      (github.event_name == 'issue_comment' && (
        contains(github.event.comment.body, ' /oc') ||
        startsWith(github.event.comment.body, '/oc') ||
        contains(github.event.comment.body, ' /opencode') ||
        startsWith(github.event.comment.body, '/opencode')
      )) ||
      (github.event_name == 'pull_request_review_comment' && (
        contains(github.event.comment.body, ' /oc') ||
        startsWith(github.event.comment.body, '/oc') ||
        contains(github.event.comment.body, ' /opencode') ||
        startsWith(github.event.comment.body, '/opencode')
      ))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install OpenCode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Get PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get PR context
        id: pr-context
        run: |
          gh api /repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }} > /tmp/pr_info.json
          echo "head_sha=$(jq -r .head.sha /tmp/pr_info.json)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch PR data
        run: |
          gh pr diff ${{ steps.pr-number.outputs.number }} > /tmp/pr_diff.txt
          gh api /repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }}/comments > /tmp/existing_comments.json
          gh api /repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }}/files > /tmp/files.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run OpenCode review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr-number.outputs.number }}
          PR_HEAD_SHA: ${{ steps.pr-context.outputs.head_sha }}
        run: |
          opencode run --agent pr-reviewer --model zai-coding-plan/glm-4.6 "Review PR #${{ steps.pr-number.outputs.number }}"

      - name: Post review
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }}/reviews" \
            --input /tmp/review.json || {
            echo "::error::Failed to post review"
            echo "::group::Review JSON content"
            cat /tmp/review.json
            echo "::endgroup::"
            exit 1
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
