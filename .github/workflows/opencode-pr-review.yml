name: OpenCode PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

jobs:
  opencode:
    # Run automatically on non-draft PRs
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.draft == false) ||
      (github.event_name == 'issue_comment' && (
        contains(github.event.comment.body, ' /oc') ||
        startsWith(github.event.comment.body, '/oc') ||
        contains(github.event.comment.body, ' /opencode') ||
        startsWith(github.event.comment.body, '/opencode')
      )) ||
      (github.event_name == 'pull_request_review_comment' && (
        contains(github.event.comment.body, ' /oc') ||
        startsWith(github.event.comment.body, '/oc') ||
        contains(github.event.comment.body, ' /opencode') ||
        startsWith(github.event.comment.body, '/opencode')
      ))
    runs-on: ubuntu-latest
    steps:
      - name: Run OpenCode review
        uses: anomalyco/opencode/github@latest
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          model: zai-coding-plan/glm-4.7
          prompt: |
            You are performing a comprehensive code review for a TypeScript/React web application using the GitHub CLI.

            IMPORTANT - OUTPUT DELIVERY:
            You MUST use the GitHub CLI (gh) to post your review comments. The gh CLI is already authenticated and available.
            - Post inline code comments using: gh pr comment $PR_NUMBER --body "COMMENT" --repo $REPO
            - For inline comments on specific lines: gh pr comment $PR_NUMBER --body "COMMENT" --repo $REPO --path FILE_PATH --line LINE_NUMBER
            - Post a summary review comment using: gh pr comment $PR_NUMBER --body "SUMMARY" --repo $REPO

            PR INFORMATION:
            - Repository: ${{ github.repository }}
            - PR Number: ${{ github.event.pull_request.number }}
            - PR Head SHA: ${{ github.event.pull_request.head.sha }}

            OBJECTIVE:
            Perform a thorough code review covering:
            1. PR Summary & Description Analysis
            2. Inline Code Comments (line-specific feedback) - MUST use gh CLI to post these
            3. Security/Vulnerability Scanning
            4. File-level Review (high-level analysis)

            TECHNICAL CONTEXT:
            - React 19 with TanStack Router for routing
            - TailwindCSS v4 for styling (utility-first CSS)
            - Convex for backend (serverless functions, schema, real-time)
            - TypeScript with strict mode enabled
            - Bun as package manager

            Project conventions:
            - Path aliases: @/* ‚Üí ./src/*, @backend/* ‚Üí ./convex/*
            - Component-based architecture
            - Type safety enforced (no any without justification)
            - Modern React patterns (hooks, functional components)

            REVIEW FOCUS:
            - Frontend: React components, hooks, routing, state management
            - Backend: Convex functions, schema, queries, mutations
            - Styling: TailwindCSS usage, responsive design
            - Type Safety: Proper TypeScript usage, type guards, validation

            SECURITY CHECKS (OWASP Top 10):
            - SQL Injection vulnerabilities
            - Cross-Site Scripting (XSS)
            - Broken Authentication
            - Sensitive Data Exposure
            - Broken Access Control
            - Security Misconfiguration
            - Hardcoded secrets, credentials, or API keys
            - Insecure cryptographic practices
            - Input validation and sanitization
            - Path traversal vulnerabilities

            ISSUE CATEGORIES (in priority order):
            - üö® Critical: Null/undefined dereferences, crashes, data corruption
            - üîí Security: Injection attacks, auth bypass, exposure
            - ‚ö° Performance: N+1 queries, unnecessary re-renders, memory leaks
            - ‚ö†Ô∏è Logic: Incorrect behavior, edge cases, state management
            - ‚ú® Improvement: Best practices, code quality, maintainability
            - üìù Clarity: Confusing code, missing comments, naming

            GUIDELINES:
            - Be constructive and helpful
            - Prioritize critical security and logic issues
            - Keep comments concise and actionable
            - Use emojis for visual clarity
            - Always provide inline comments for code-specific issues using gh CLI
            - Consider the project's technical context and conventions

            DELIVERY INSTRUCTIONS:
            1. First, post a comprehensive summary comment on the PR using: gh pr comment $PR_NUMBER --body "FULL_SUMMARY" --repo $REPO
            2. Then, for each specific code issue, post an inline comment using: gh pr comment $PR_NUMBER --body "ISSUE_COMMENT" --repo $REPO --path FILE_PATH --line LINE_NUMBER

            The summary should include:
            1. PR Summary (overview, files changed, main components, impact)
            2. Security Analysis (with severity ratings)
            3. File-level review with quality assessments
