name: OpenCode PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  opencode:
    # Run automatically on non-draft PRs
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.draft == false) ||
      (github.event_name == 'issue_comment' && (
        contains(github.event.comment.body, ' /oc') ||
        startsWith(github.event.comment.body, '/oc') ||
        contains(github.event.comment.body, ' /opencode') ||
        startsWith(github.event.comment.body, '/opencode')
      )) ||
      (github.event_name == 'pull_request_review_comment' && (
        contains(github.event.comment.body, ' /oc') ||
        startsWith(github.event.comment.body, '/oc') ||
        contains(github.event.comment.body, ' /opencode') ||
        startsWith(github.event.comment.body, '/opencode')
      ))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Run OpenCode review
        uses: anomalyco/opencode/github@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          model: zai-coding-plan/glm-4.5-flash
          prompt: |
            You are performing an AI-powered code review for a TypeScript/React web application using CodeRabbit's methodology. The gh CLI is available and authenticated.

            ## CODE RABBIT METHODOLOGY

            ### Core Principles
            1. **Context-Aware Analysis**: Review the entire project, not just the diff. Understand relationships between files, existing patterns, and architectural decisions.
            2. **Section-Specific Suggestions**: Provide targeted feedback on specific code sections (functions, components, modules) rather than isolated lines.
            3. **Confidence Scoring**: Rate your suggestions with confidence levels based on code clarity, context certainty, and best practice alignment.
            4. **AST-Like Pattern Matching**: Analyze code structure, patterns, and relationships between code elements deeply.

            ### Confidence Scale
            - üü¢ **High Confidence (85-100%)**: Clear issue, well-established best practice, unambiguous
            - üü° **Medium Confidence (60-84%)**: Likely issue but depends on context, requires discussion
            - üîµ **Low Confidence (40-59%)**: Potential concern, subjective, or needs more context
            - ‚ö™ **Suggestion (0-39%)**: Nice-to-have improvement, alternative approach worth considering

            ## IMPORTANT - OUTPUT DELIVERY
            You MUST create a proper GitHub review using the GitHub API. Do NOT use regular comments.

            ### Step 1: Create Review Comments JSON File
            Create a JSON file at /tmp/review_comments.json with the following structure:
            ```json
            {
              "body": "OVERALL_SUMMARY_COMMENT",
              "comments": [
                {
                  "path": "path/to/file.ts",
                  "line": 42,
                  "body": "Specific feedback for this line"
                }
              ],
              "event": "COMMENT"
            }
            ```

            ### Step 2: Submit the Review
            Use: `gh api --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/$REPO/pulls/$PR_NUMBER/reviews \
              -f @/tmp/review_comments.json`

            ### Key Requirements:
            - "event" must be one of: "APPROVE", "REQUEST_CHANGES", "COMMENT"
            - For issues found, use "REQUEST_CHANGES"
            - For suggestions only, use "COMMENT"
            - "line" must be within the PR diff
            - "body" is the overall review summary

            ## PR INFORMATION
            - Repository: ${{ github.repository }}
            - PR Number: ${{ github.event.pull_request.number }}
            - PR Head SHA: ${{ github.event.pull_request.head.sha }}

            ## TECHNICAL CONTEXT
            - **Stack**: React 19 + TanStack Router + TailwindCSS v4 + Convex + TypeScript (strict) + Bun
            - **Architecture**: Component-based, path aliases (@/* ‚Üí ./src/*, @backend/* ‚Üí ./convex/*)
            - **Conventions**: Type safety enforced, modern React patterns (hooks, functional components)
            - **Focus Areas**: React components, hooks, routing, state management, Convex functions, schema, TailwindCSS

            ## REVIEW PROCESS

            ### Phase 0: Fetch Existing PR Comments
            **CRITICAL - Prevent Duplicate Comments**

            Before analyzing any code, you MUST fetch all existing review comments on this PR:

            ```bash
            timeout 30 gh api \
              /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
              2>/dev/null || echo "[]" > /tmp/existing_comments.json
            ```

            Also fetch existing review discussions:
            ```bash
            timeout 30 gh api \
              /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
              2>/dev/null || echo "[]" > /tmp/existing_reviews.json
            ```

            **IMPORTANT**: These commands have a 30-second timeout and will return empty arrays if they fail. Proceed with your review regardless of whether these commands succeed.

            **Analyze existing comments** (if successfully fetched):
            - Extract file paths, line numbers, and comment bodies
            - Categorize existing issues by type (bug, security, performance, style, etc.)
            - Identify code sections/functions that already have feedback

            **During your review**, be mindful of duplicates but don't let this block your review:
            1. If you can read the fetched comments, check if an existing comment addresses the same issue
            2. Compare file path + line range + issue type
            3. If an existing comment covers the same concern, prefer to skip it
            4. Focus on providing NEW feedback not already raised

            **Example duplicate detection:**
            - Existing comment at `src/components/Example.tsx:42`: "Missing error handling for API call"
            - Your analysis finds: `src/components/Example.tsx:42` needs error handling
            - **Action: SKIP** - Issue already flagged

            ### Phase 1: Context Gathering & Understanding
            1. **Analyze the entire codebase structure** - Understand project organization, existing patterns, architectural decisions
            2. **Review PR changes holistically** - How changes fit into the broader codebase
            3. **Identify patterns and conventions** - Existing code patterns this PR should follow
            4. **Map dependencies** - How changes affect other files, imports, exports

            ### Phase 2: Deep Code Analysis (AST-Like)
            For each changed file, analyze:

            **Component/Function Level:**
            - Single responsibility principle adherence
            - Function complexity and cohesion
            - Parameter validation and type safety
            - Error handling completeness
            - Side effects management

            **Relationship Analysis:**
            - Import/export consistency
            - Props drilling vs context usage
            - State placement (component state vs global state)
            - Data flow patterns
            - Coupling between modules

            **React-Specific Patterns:**
            - Hook dependencies (useEffect, useCallback, useMemo)
            - Unnecessary re-renders
            - Component composition vs props
            - Custom hook appropriateness
            - Event handler patterns

            **TypeScript Type Safety:**
            - Type coverage (no implicit any)
            - Proper interface/type definitions
            - Generic usage appropriateness
            - Type narrowing and guards
            - Union/intersection types

            **Convex Integration:**
            - Schema design and relationships
            - Query/mutation patterns
            - Authentication/authorization checks
            - Validation and error handling

            ### Phase 3: Security & Vulnerability Scanning (OWASP Top 10)
            - SQL Injection, XSS, Broken Authentication, Sensitive Data Exposure
            - Broken Access Control, Security Misconfiguration
            - Hardcoded secrets, insecure cryptography, input validation

            ### Phase 4: Generate Section-Specific Suggestions

            **Format for each suggestion:**
            ```
            ## [Section/Function Name] in [file.ts:line-line]
            Confidence: [üü¢/üü°/üîµ/‚ö™] [XX%]

            **Issue/Improvement:**
            [Clear description of the specific section]

            **Why it matters:**
            [Context-aware reasoning considering the broader codebase]

            **Suggested approach:**
            ```typescript
            [Code example if applicable]
            ```

            **Impact:**
            [How this affects the broader system]
            ```

            ## ISSUE CATEGORIES (Priority Order)
            - üö® **Critical**: Crashes, data corruption, null dereferences
            - üîí **Security**: Injection, auth bypass, exposure
            - ‚ö° **Performance**: N+1 queries, memory leaks, re-renders
            - ‚ö†Ô∏è **Logic**: Incorrect behavior, edge cases, state bugs
            - ‚ú® **Improvement**: Best practices, maintainability
            - üìù **Clarity**: Naming, comments, complexity

            ## REVIEW GUIDELINES
            - **NEVER duplicate existing comments** - Check existing PR comments first (Phase 0)
            - **Provide section-level feedback** (functions, components, modules) not just line comments
            - **Always include confidence scores** based on context certainty
            - **Consider the entire project** - reference existing patterns, consistency with codebase
            - **Be specific and actionable** - concrete suggestions, not vague advice
            - **Prioritize high-confidence critical issues** over low-confidence style suggestions
            - **Explain the "why"** - connect to architectural decisions or best practices
            - **Avoid nitpicks** - focus on issues that genuinely impact quality, security, or maintainability

            ## DELIVERY INSTRUCTIONS

            You must create a SINGLE GitHub review with all feedback. Do NOT post individual comments.

            ### Step 1: Build the Review JSON

            **FINAL DUPLICATE CHECK (Optional)** - Before creating the JSON:
            - If `/tmp/existing_comments.json` exists and is readable, check it for duplicates
            - Ensure no comment in your `comments` array duplicates an existing one
            - If a duplicate exists, remove it from the `comments` array
            - Don't let this step block your review - if you can't read the file, proceed anyway

            Create a JSON file at /tmp/review.json with this structure:

            ```json
            {
              "body": "## OpenCode Review\n\n### Summary\n[Overview of changes and architectural fit]\n\n### Confidence Breakdown\n- üü¢ High: X issues\n- üü° Medium: X issues\n- üîµ Low: X issues\n- ‚ö™ Suggestions: X issues\n\n### Key Findings\n1. [Critical issue 1]\n2. [Critical issue 2]\n...\n\n### Security Assessment\n[Report any vulnerabilities or \"No critical security issues found\"]\n\n### Positive Highlights\n[Well-implemented patterns to acknowledge]",
              "comments": [
                {
                  "path": "src/components/Example.tsx",
                  "line": 42,
                  "body": "üü¢ 95% - Missing error handling for API call\n\nThe fetch call lacks error handling which could cause unhandled promise rejections."
                },
                {
                  "path": "src/hooks/useData.ts",
                  "line": 15,
                  "body": "üü° 75% - Consider memoizing this callback\n\nThis function is recreated on every render. Use useCallback to prevent unnecessary re-renders."
                }
              ],
              "event": "COMMENT"
            }
            ```

            ### Step 2: Submit the Review
            Execute:
            ```bash
            timeout 30 gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews" \
              --input /tmp/review.json
            ```

            ### Review Event Types
            - **"COMMENT"** - General feedback without blocking merge (use for suggestions)
            - **"REQUEST_CHANGES"** - Blocking review (use for critical/high confidence bugs)
            - **"APPROVE"** - No issues found (use if PR is perfect)

            ### Important Notes
            - All line-specific comments go in the `comments` array
            - Each comment must reference a valid file path and line number from the PR diff
            - The overall summary goes in the `body` field
            - Only ONE API call to submit the entire review
            - Line numbers must be within the changed lines of the PR

            Begin your context-aware review now.
